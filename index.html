<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plyr Player – Custom URL & CORS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .bar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    input[type="url"] { flex: 1; min-width: 320px; padding: 8px; }
    button { padding: 8px 12px; cursor: pointer; }
    .note { font-size: 13px; color: #555; margin-top: 8px; }
    .warn { color: #b00020; margin-top: 8px; }
  </style>
</head>
<body>

  <h1>Plyr Video Player</h1>
  <div class="bar">
    <input id="videoUrl" type="url" placeholder="Paste video URL (mp4, webm, mkv, m3u8)" />
    <button id="loadBtn">Load</button>
  </div>
  <div id="msg" class="note">Supports MP4/WebM natively, HLS via hls.js. MKV may not play in many browsers.</div>

  <!-- Video element -->
  <video id="player" playsinline controls crossorigin="anonymous"></video>

  <!-- Plyr JS -->
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
  <!-- hls.js for HLS playback in non-Safari browsers -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    const video = document.getElementById('player');
    const plyr = new Plyr(video, {
      // Customize Plyr as needed
      captions: { active: true, update: true },
      controls: [
        'play-large', 'play', 'progress', 'current-time', 'mute', 'volume',
        'captions', 'settings', 'pip', 'airplay', 'fullscreen'
      ]
    });

    const msg = document.getElementById('msg');
    const urlInput = document.getElementById('videoUrl');
    const loadBtn = document.getElementById('loadBtn');

    function updateMessage(text, isWarn = false) {
      msg.textContent = text;
      msg.className = isWarn ? 'warn' : 'note';
    }

    function getExt(u) {
      try {
        const url = new URL(u);
        const pathname = url.pathname.toLowerCase();
        const qf = url.searchParams.get('format') || '';
        if (pathname.endsWith('.m3u8') || qf === 'm3u8') return 'm3u8';
        if (pathname.endsWith('.mp4')) return 'mp4';
        if (pathname.endsWith('.webm')) return 'webm';
        if (pathname.endsWith('.mkv')) return 'mkv';
        return '';
      } catch {
        return '';
      }
    }

    async function loadSource(src) {
      if (!src) {
        updateMessage('Please paste a valid URL.');
        return;
      }
      const ext = getExt(src);

      // Reset previous hls instance if any
      if (video.hls) {
        video.hls.destroy();
        video.hls = null;
      }

      // Handle HLS (.m3u8)
      if (ext === 'm3u8') {
        if (video.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari can play HLS natively
          video.src = src;
          plyr.source = {
            type: 'video',
            sources: [{ src, type: 'application/vnd.apple.mpegurl' }]
          };
          updateMessage('Playing HLS via native support.');
        } else if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({ enableWorker: true });
          hls.loadSource(src);
          hls.attachMedia(video);
          video.hls = hls;
          updateMessage('Playing HLS via hls.js.');
        } else {
          updateMessage('HLS not supported in this browser.', true);
        }
        return;
      }

      // Handle MP4/WebM
      if (ext === 'mp4' || ext === 'webm') {
        const type = ext === 'mp4' ? 'video/mp4' : 'video/webm';
        plyr.source = {
          type: 'video',
          sources: [{ src, type }]
        };
        updateMessage(`Playing ${ext.toUpperCase()} via HTML5 video.`);
        return;
      }

      // Attempt MKV (not reliable)
      if (ext === 'mkv') {
        // Some browsers may accept 'video/x-matroska', but most MKV won’t play.
        plyr.source = {
          type: 'video',
          sources: [{ src, type: 'video/x-matroska' }]
        };
        updateMessage('Attempting MKV. If it fails, convert to MP4/WebM or stream via HLS/DASH.', true);
        return;
      }

      // Unknown extension: try generic or let the browser decide
      plyr.source = {
        type: 'video',
        sources: [{ src }]
      };
      updateMessage('Unknown format. Trying generic playback. If it fails, use MP4/WebM or HLS.', true);
    }

    loadBtn.addEventListener('click', () => loadSource(urlInput.value.trim()));

    // Optional: load a demo URL on start
    // urlInput.value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
    // loadSource(urlInput.value);
  </script>

  <div class="note">
    To allow cross-origin playback, the video server must send CORS headers:
    <br>- Access-Control-Allow-Origin: * (or your domain)
    <br>- Access-Control-Allow-Headers: Range, Origin, Accept
    <br>- Access-Control-Expose-Headers: Content-Length, Accept-Ranges
    <br>- Supports HTTP Range requests for seeking (Accept-Ranges: bytes)
  </div>
</body>
</html>
